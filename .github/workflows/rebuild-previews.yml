name: Rebuild all Netlify Previews

on:
  workflow_dispatch: # run manually from Actions tab

permissions:
  contents: read
  pull-requests: read

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch open PRs
        id: prs
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/pulls?state=open
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Netlify previews for each PR
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "üîÅ Rebuilding previews for open PRs..."
          echo "${{ steps.prs.outputs.data }}" | jq -r '.[].head.ref' | while read branch; do
            echo "‚û°Ô∏è  Triggering Netlify build for $branch"
            curl -s -X POST \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"trigger_branch\":\"$branch\"}" \
              https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds \
              && echo "‚úÖ Triggered for $branch" || echo "‚ùå Failed for $branch"
          done
