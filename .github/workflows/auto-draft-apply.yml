name: Apply Auto Draft

on:
  workflow_run:
    workflows: ["Auto Draft"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  apply-draft:
    runs-on: ubuntu-latest

    steps:
      - name: Pobierz szczeg√≥≈Çy workflow_run
        id: get_info
        run: |
          echo "PR_NUMBER=$(jq -r '.pull_requests[0].number' <<< '${{ toJson(github.event.workflow_run) }}')" >> $GITHUB_ENV
          echo "REPO=$(jq -r '.repository.full_name' <<< '${{ toJson(github.event.workflow_run) }}')" >> $GITHUB_ENV

      - name: Pobierz artefakt z poprzedniego workflow
        uses: actions/download-artifact@v4
        with:
          name: auto-draft-result
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./artifact

      - name: Odczytaj wynik
        id: read_result
        run: |
          if [ -f ./artifact/result.json ]; then
            cat ./artifact/result.json
            echo "DRAFT_APPLIED=$(jq -r '.draftApplied' ./artifact/result.json)" >> $GITHUB_ENV
          else
            echo "DRAFT_APPLIED=false" >> $GITHUB_ENV
          fi

      - name: Oznacz PR jako draft (je≈õli dotyczy)
        if: env.DRAFT_APPLIED == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            console.log(`Ustawiam draft dla PR #${pr_number}`);
            await github.rest.pulls.update({
              ...context.repo,
              pull_number: pr_number,
              draft: true
            });

      - name: Sprawd≈∫ czy komentarz ju≈º istnieje
        if: env.DRAFT_APPLIED == 'true'
        id: check_comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: pr_number,
            });
            const existing = comments.find(c => c.body?.includes('<!-- auto-draft-marker -->'));
            core.setOutput('exists', existing ? 'true' : 'false');

      - name: Dodaj komentarz (tylko raz)
        if: env.DRAFT_APPLIED == 'true' && steps.check_comment.outputs.exists != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = [
              'üëã Ten PR zosta≈Ç automatycznie przekonwertowany na **draft**.',
              '',
              'Tylko upowa≈ºnieni u≈ºytkownicy mogƒÖ oznaczaƒá PR jako gotowy (‚ÄúReady for review‚Äù) do ko≈Ñcowego przeglƒÖdu.',
              'Je≈õli uwa≈ºasz, ≈ºe jest to b≈ÇƒÖd, skontaktuj siƒô z administratorem.',
              '',
              '<!-- auto-draft-marker -->'
            ].join('\n');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: process.env.PR_NUMBER,
              body: message
            });
