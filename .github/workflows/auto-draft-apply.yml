name: Apply Auto Draft

on:
  workflow_run:
    workflows: ["Auto Draft"]
    types: [completed]

permissions:
  pull-requests: write
  issues: write
  actions: write
  contents: read

jobs:
  apply-draft:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Download artifact from base workflow
      - name: Pobierz artefakt z Auto Draft
        uses: actions/download-artifact@v6
        with:
          name: auto-draft-result
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./artifact

      # 2ï¸âƒ£ Read draftApplied and PR number
      - name: Read result
        id: read_result
        run: |
          if [ -f ./artifact/result.json ]; then
            cat ./artifact/result.json
            DRAFT_APPLIED=$(jq -r '.draftApplied' ./artifact/result.json)
            PR_NUMBER=$(jq -r '.prNumber' ./artifact/result.json)
            echo "DRAFT_APPLIED=$DRAFT_APPLIED" >> $GITHUB_ENV
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          else
            echo "DRAFT_APPLIED=false" >> $GITHUB_ENV
            echo "PR_NUMBER=" >> $GITHUB_ENV
          fi

      # 3ï¸âƒ£ Mark PR as draft (if needed)
      - name: Oznacz PR jako draft (jeÅ›li dotyczy)
        if: env.DRAFT_APPLIED == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            console.log(`Ustawiam draft dla PR #${pr_number}`);
            await github.rest.pulls.update({
              ...context.repo,
              pull_number: pr_number,
              draft: true
            });

      # 4ï¸âƒ£ Check if comment already exists
      - name: SprawdÅº czy komentarz juÅ¼ istnieje
        if: env.DRAFT_APPLIED == 'true'
        id: check_comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: pr_number,
            });
            const existing = comments.find(c => c.body?.includes('<!-- auto-draft-marker -->'));
            core.setOutput('exists', existing ? 'true' : 'false');

      # 5ï¸âƒ£ Add comment (once)
      - name: Dodaj komentarz (tylko raz)
        if: env.DRAFT_APPLIED == 'true' && steps.check_comment.outputs.exists != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            const message = [
              'ğŸ‘‹ Ten PR zostaÅ‚ automatycznie przekonwertowany na **draft**.',
              '',
              'Tylko upowaÅ¼nieni uÅ¼ytkownicy mogÄ… oznaczaÄ‡ PR jako gotowy (â€œReady for reviewâ€) do koÅ„cowego przeglÄ…du.',
              'JeÅ›li uwaÅ¼asz, Å¼e jest to bÅ‚Ä…d, skontaktuj siÄ™ z administratorem.',
              '',
              '<!-- auto-draft-marker -->'
            ].join('\n');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr_number,
              body: message
            });
