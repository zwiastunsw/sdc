name: Apply Auto Draft

on:
  workflow_run:
    workflows: ["Auto Draft"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  apply-draft:
    runs-on: ubuntu-latest

    steps:
      - name: Download result artifact
        uses: actions/download-artifact@v6
        with:
          name: auto-draft-result
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./artifact

      - name: Read result
        id: read
        run: |
          echo "Result file content:"
          cat artifact/result.json
          DRAFT_APPLIED=$(jq -r '.draftApplied' artifact/result.json)
          PR_NUMBER=$(jq -r '.prNumber' artifact/result.json)
          echo "draftApplied=$DRAFT_APPLIED" >> $GITHUB_ENV
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Convert PR to draft if needed
        if: env.draftApplied == 'true'
        id: convert
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            try {
              const { data: pr } = await github.rest.pulls.get({
                ...context.repo,
                pull_number: pr_number
              });

              if (pr.draft) {
                console.log(`PR #${pr_number} is already draft â€” skipping.`);
                core.setOutput("converted", "false");
                return;
              }

              console.log(`Converting PR #${pr_number} to draft...`);
              await github.rest.pulls.update({
                ...context.repo,
                pull_number: pr_number,
                draft: true
              });
              console.log(`âœ… Successfully converted PR #${pr_number} to draft.`);
              core.setOutput("converted", "true");
            } catch (error) {
              console.error(`âŒ Failed to convert PR #${pr_number} to draft:`, error.message);
              core.setOutput("converted", "false");
            }

      - name: Check if comment already exists
        if: steps.convert.outputs.converted == 'true'
        id: check_comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = process.env.PR_NUMBER;
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: pr_number,
            });
            const existing = comments.find(c => c.body?.includes('<!-- auto-draft-marker -->'));
            core.setOutput('exists', existing ? 'true' : 'false');

      - name: Add comment (only if conversion happened and no previous comment)
        if: steps.convert.outputs.converted == 'true' && steps.check_comment.outputs.exists != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = [
              'ğŸ‘‹ Ten PR zostaÅ‚ automatycznie przekonwertowany na **draft**.',
              '',
              'Tylko upowaÅ¼nieni uÅ¼ytkownicy mogÄ… oznaczaÄ‡ PR jako gotowy (â€œReady for reviewâ€).',
              'JeÅ›li uwaÅ¼asz, Å¼e to bÅ‚Ä…d, skontaktuj siÄ™ z administratorem.',
              '',
              '<!-- auto-draft-marker -->'
            ].join('\n');

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: process.env.PR_NUMBER,
              body: message
            });
